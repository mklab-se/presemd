name: Release

on:
  push:
    tags:
      - "v*"

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

jobs:
  # Run the full CI suite before building release artifacts
  ci:
    name: CI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt
      - uses: Swatinem/rust-cache@v2
      - run: cargo fmt --all -- --check
      - run: cargo clippy --workspace -- -D warnings
      - run: cargo test --workspace

  # Build release binaries for each platform
  build:
    name: Build ${{ matrix.target }}
    needs: ci
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            archive: tar.gz
          - target: x86_64-apple-darwin
            os: macos-latest
            archive: tar.gz
          - target: aarch64-apple-darwin
            os: macos-latest
            archive: tar.gz
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            archive: zip
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}

      - name: Build release binary
        shell: bash
        run: cargo build --release --target "$TARGET"
        env:
          TARGET: ${{ matrix.target }}

      - name: Package (unix)
        if: matrix.archive == 'tar.gz'
        shell: bash
        run: |
          cd "target/${TARGET}/release"
          tar czf "../../../presemd-${RELEASE_TAG}-${TARGET}.tar.gz" presemd
          cd ../../..
        env:
          TARGET: ${{ matrix.target }}
          RELEASE_TAG: ${{ github.ref_name }}

      - name: Package (windows)
        if: matrix.archive == 'zip'
        shell: pwsh
        run: |
          Compress-Archive -Path "target/$env:TARGET/release/presemd.exe" -DestinationPath "presemd-$env:RELEASE_TAG-$env:TARGET.zip"
        env:
          TARGET: ${{ matrix.target }}
          RELEASE_TAG: ${{ github.ref_name }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: presemd-${{ matrix.target }}
          path: presemd-${{ github.ref_name }}-${{ matrix.target }}.*

  # Create GitHub Release with all binaries
  github-release:
    name: GitHub Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: artifacts/*

  # Update Homebrew tap with new version and SHA256 hashes
  homebrew:
    name: Update Homebrew Tap
    needs: github-release
    runs-on: ubuntu-latest
    steps:
      - name: Update formula
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          set -e
          VERSION="${GITHUB_REF_NAME#v}"
          TAG="${GITHUB_REF_NAME}"
          BASE_URL="https://github.com/mklab-se/presemd/releases/download/${TAG}"

          # Download release artifacts and compute SHA256
          curl -sL "${BASE_URL}/presemd-${TAG}-aarch64-apple-darwin.tar.gz" -o aarch64-darwin.tar.gz
          curl -sL "${BASE_URL}/presemd-${TAG}-x86_64-apple-darwin.tar.gz" -o x86_64-darwin.tar.gz
          curl -sL "${BASE_URL}/presemd-${TAG}-x86_64-unknown-linux-gnu.tar.gz" -o x86_64-linux.tar.gz

          SHA_AARCH64=$(sha256sum aarch64-darwin.tar.gz | cut -d' ' -f1)
          SHA_X86_64=$(sha256sum x86_64-darwin.tar.gz | cut -d' ' -f1)
          SHA_LINUX=$(sha256sum x86_64-linux.tar.gz | cut -d' ' -f1)

          # Generate formula
          cat > formula.rb <<RUBY
          class Presemd < Formula
            desc "A markdown-based presentation tool"
            homepage "https://github.com/mklab-se/presemd"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/mklab-se/presemd/releases/download/v#{version}/presemd-v#{version}-aarch64-apple-darwin.tar.gz"
                sha256 "${SHA_AARCH64}"
              else
                url "https://github.com/mklab-se/presemd/releases/download/v#{version}/presemd-v#{version}-x86_64-apple-darwin.tar.gz"
                sha256 "${SHA_X86_64}"
              end
            end

            on_linux do
              url "https://github.com/mklab-se/presemd/releases/download/v#{version}/presemd-v#{version}-x86_64-unknown-linux-gnu.tar.gz"
              sha256 "${SHA_LINUX}"
            end

            def install
              bin.install "presemd"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/presemd --version")
            end
          end
          RUBY

          # Push to homebrew-tap repo via GitHub API
          CONTENT=$(base64 -w 0 < formula.rb)
          FILE_SHA=$(gh api repos/mklab-se/homebrew-tap/contents/Formula/presemd.rb --jq '.sha' 2>/dev/null || echo "")

          if [ -n "$FILE_SHA" ]; then
            gh api repos/mklab-se/homebrew-tap/contents/Formula/presemd.rb \
              -X PUT \
              -f message="Update presemd to ${VERSION}" \
              -f content="$CONTENT" \
              -f sha="$FILE_SHA" \
              && echo "Homebrew formula updated to ${VERSION}" \
              || echo "::warning::Failed to update Homebrew tap. Add HOMEBREW_TAP_TOKEN secret with repo scope for mklab-se/homebrew-tap."
          else
            # Create file for the first time
            gh api repos/mklab-se/homebrew-tap/contents/Formula/presemd.rb \
              -X PUT \
              -f message="Add presemd ${VERSION}" \
              -f content="$CONTENT" \
              && echo "Homebrew formula created for ${VERSION}" \
              || echo "::warning::Failed to create Homebrew formula. Add HOMEBREW_TAP_TOKEN secret with repo scope for mklab-se/homebrew-tap."
          fi

  # Publish to crates.io
  crates-io:
    name: Publish to crates.io
    needs: ci
    runs-on: ubuntu-latest
    environment: crates-io
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Publish presemd
        run: cargo publish -p presemd
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
